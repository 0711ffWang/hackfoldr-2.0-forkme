extends _template

block title

block body

  nav#sidebar

    nav#nav
      .ui.borderless.menu
        .ui.dropdown.icon.item.shortcuts
          i.icon.home
          include shortcuts-menu
        .ui.dropdown.icon.item.history
          i.icon.time
          .menu
        .ui.dropdown.icon.item.about
          i.icon.help
          .menu
            a.link.item(href="https://g0v.hackpad.com/welcome_to_hackfoldr#Welcome-to-Hackfoldr",target="iframe") 使用說明
              i.icon.text.file.outline
            a.foldr.item(href="/welcome-to-hackfoldr") 開發與回報
              i.icon.exchange
            a.link.item(href="https://github.com/hackfoldr/maker.moztw.org",target="_blank") 程式碼
              i.icon.github
        a.right.item.expand.button.collapsed.mode.hidden
          i.icon.arrow.right
        a.right.item.collapse.button.expanded.mode
          i.icon.arrow.left
        .right.icon.item.zoom.ui.dropdown
          i.icon.zoom.in
          .menu
            .item.normal 100%
            .item.large 130%
            .item.larger 150%

    nav#topbar
      .ui.borderless.menu
        a.item.foldr.title
        a.right.icon.item.edit.table(target="iframe")
          i.icon.pencil
        a.right.icon.item.refresh.table.hidden
          i.icon.repeat
        a.right.icon.item.add.to.list
          i.icon.add
      form.ui.form.segment.no.margin.hidden.expanded.mode
        .field
          input.new.title(placeholder="hackpad id 或名稱",type="text",name="new-pad-name",value="文件標題，空白可，符號不能")
        //-.field
          input.new.url(placeholder="想使用的 hackpad ID",type="text",name="new-pad-id",value="new-pad-id_such-as_123g0v")
        //-.inline.field
          input.new.instance(placeholder="hackpad 站台名稱",type="text",name="new-pad-instance",value="g0v",size="10")
          | .hackpad.com
        .ui.submit.button.green.small create and add to foldr
    nav#toc
      .ui.vertical.menu

  #wrapper

    .frame
      iframe#iframe(name="iframe")

block script
  script.

    var paths = location.pathname.split('/') || [];
    var ethercalc_name     = paths[1] || "welcome-to-hackfoldr";
    var current_iframe_url = paths[2] ? unescape(unescape(paths[2])) : null;
    var iframe_src;
    var history_state={};
    var foldr_histories = JSON.parse(localStorage.getItem("hackfoldr")) || [];
    var foldr_scale = JSON.parse(localStorage.getItem("hackfoldr-scale")) || "";

    var compile_ethercalc = function(){
      $.get('https://ethercalc.org/_/'+ethercalc_name+'/csv').pipe(CSV.parse).done(function(rows){

        var got_title = false
        var depth = 0 // if depth == 1, link should in accordion

        var link_template_source ='<a href="{{url}}" target="{{target}}" class="{{type}} item">{{subject}}<i class="icon {{icon}}"></i></a>';
        var link_template = Handlebars.compile(link_template_source);

        var add_link = function(row){
          try{
            var link_options = JSON.parse(row[2]);
          }catch(e){
            var link_options = {};
          }

          // auto link icon
          var link_icon = "";
          var link_type = "link";
          var link_target = "iframe";
          var link_url = row[0].trim();
          if(link_url.match(/^.*.hackpad.com\//)){
            link_icon = "text file outline";
          } else if(link_url.match(/^.*.etherpad.mozilla.org\//)) {
            link_icon = "file outline";
          } else if(link_url.match(/^.*.groups.google.com\//)) {
            link_icon = "users";
          } else if(link_url.match(/^.*.plus.google.com\//)) {
            link_icon = "google plus";
          } else if(link_url.match(/^.*.kktix.cc\//)) {
            link_icon = "bullhorn";
          } else if(link_url.match(/^.*.kktix.com\//)) {
            link_icon = "bullhorn";
          } else if(link_url.match(/^.*.registrano.com\//)) {
            link_icon = "bullhorn";
          } else if(link_url.match(/^.*.docs.google.com\/spreadsheet.*/)) {
            link_icon = "table";
          } else if(link_url.match(/^.*.docs.google.com\/drawings.*/)) {
            link_icon = "photo";
          } else if(link_url.match(/^.*.docs.google.com\/document.*/)) {
            link_icon = "text file";
          } else if(link_url.match(/^.*.docs.google.com\/presentation.*/)) {
            link_icon = "laptop";
          } else if(link_url.match(/^.*.docs.google.com\/form.*/)) {
            link_icon = "unordered list";
          } else if(link_url.match(/^.*.drive.google.com\//)) {
            link_icon = "cloud";
          } else if(link_url.match(/^.*.github.com\//)) {
            link_icon = "github";
          } else if(link_url.match(/^.*.moqups.com\//)) {
            link_icon = "photo";
          } else if(link_url.match(/^.*.facebook.com\//)) {
            link_icon = "facebook";
          } else if(link_url.match(/^.*.twitter.com\//)) {
            link_icon = "twitter";
          } else if(link_url.match(/^.*.tumblr.com\//)) {
            link_icon = "tumblr";
          } else if(link_url.match(/^.*.trello.com\//)) {
            link_icon = "trello";
          } else if(link_url.match(/^.*.youtube.com\//)) {
            link_icon = "youtube";
          } else if(link_url.match(/^.*.hack.g0v.tw\//)) {
            link_icon = "exchange";
            //link_url = link_url.split("/")[1].toString();
            //link_type = "foldr";
            //link_target = "";
          } else if(link_url.match(/^.*.hack.etblue.tw\//)) {
            link_icon = "exchange";
            //link_url = link_url.split("/")[1].toString();
            //link_type = "foldr";
            //link_target = "";
          } else if(link_url.match(/^.*.hackfoldr.org\//)) {
            link_icon = "exchange";
            //link_url = link_url.split("/")[1].toString();
            //link_type = "foldr";
            //link_target = "";
          } else {
            link_icon = "globe";
          }

          var context = {url: link_url, subject: row[1], icon: link_icon, type: link_type, target: link_target};
          var $link_element = $(link_template(context));

          for(key in link_options){
            $link_element.attr(key, link_options[key]);
          }

          if(depth == 1){
            $('#toc .ui.accordion:last').find('.menu').append($link_element)
          }else{
            $('#toc .ui.vertical.menu').append($link_element)
          }

          // enable default iframe?
          if(current_iframe_url == "edit"){
            iframe_src = 'https://ethercalc.org/'+ethercalc_name;
            $("#topbar .edit.table").hide();
            $("#topbar .refresh.table").show();
          }else if((new RegExp(context.url+"/?")).test(current_iframe_url)){
            iframe_src = current_iframe_url;
          }else if(/^https:\/\/.*.hackpad.com\//.test(context.url)){
            if( current_iframe_url === context.url.split(/\//).pop()){
              iframe_src = context.url;
            }
          }
          if(!iframe_src) {
            iframe_src = context.url;
          }
        }
        
        var accordion_template_source = '<div class="ui accordion"><div class="title header item ">{{title}}<i class="icon folder closed"></i><i class="icon folder open hidden" style="display: none;"></i></div><div class="content menu"></div></div>';
        var accordion_template = Handlebars.compile(accordion_template_source);

        var add_accordion = function(row){
          try{
            var options = JSON.parse(row[2]);
          }catch(e){
            var options = {};
          }
          var context = {title: row[1] };
          var $accordion_el = $(accordion_template(context));
          
          $accordion_el.appendTo('#toc .ui.vertical.menu').accordion({onChange: function(){
            $accordion_el.find('.folder').toggle()
          }})
          
          if(options.expand){
            $accordion_el.accordion('open',0)
          }
        }

        $.each(rows, function(row_index, row){

          // if 1st and 2nd is empty then this a empty row 
          if(row[0].trim().length === 0 && row[1].trim().length === 0){
            return
          }

          // now we have soming thing, should get title first
          if(!got_title){

            // TODO: need opt....
            $.each(row, function(col_index, col){
              col = col.trim()

              // get the MAGIC title 
              if(!got_title && !col.match(/^#/) && col.length > 0) {
                $('#topbar .foldr.title').html(col);
                got_title = true;

                // add to history menu

                var current_foldr_history = {
                  foldr_name: col,
                  foldr_id: ethercalc_name
                };

                // Remove all items in foldr_histories that share the same foldr_id before unshift
                foldr_histories = $.grep(foldr_histories, function(value){
                  return value !== JSON.stringify(current_foldr_history);
                });
                foldr_histories.unshift(JSON.stringify(current_foldr_history));
                localStorage.setItem("hackfoldr", JSON.stringify(foldr_histories));
              }

            })

          } else {
            if(row[0].length == 0){ // folder 
              depth = 1
              add_accordion(row)
            }else{ // link
              add_link(row)
            }
          }
        });

        // set initial iframe src attribute
        if(!$("#iframe").attr("src")){
          $("#iframe").attr("src",iframe_src);
        }

        // auto new window, and auto new window icon
        var new_window_icon = "<i class='icon forward mail'></i>";
        var open_link_in_new_window_or_not = function(){
          link_url = $(this).attr("href");
          if(link_url.match(/^.*.plus.google.com\//)) {
            return true;
          } else if(link_url.match(/^.*.kktix.cc\//)) {
            return true;
          } else if(link_url.match(/^.*.kktix.com\//)) {
            return true;
          } else if(link_url.match(/^.*.registrano.com\//)) {
            return true;
          } else if(link_url.match(/^.*.github.com\//)) {
            return true;
          } else if(link_url.match(/^.*.drive.google.com\//)) {
            return true;
          } else if(link_url.match(/^.*.facebook.com\//)) {
            return true;
          } else if(link_url.match(/^.*.trello.com\//)) {
            return true;
          } else {
            return false;
          }
        };
        $("#sidebar a.link.item").filter(open_link_in_new_window_or_not).attr("target","_blank").append(new_window_icon);
        $("#sidebar a.link.item[target='_blank']").not(":has(i.icon.forward.mail)").append(new_window_icon);

      });
    };

    compile_ethercalc();

    // setup history menu
    $.each(foldr_histories, function(index, foldr_history){
      var item = JSON.parse(foldr_history);
      $("#nav .history .menu").append(
        $('<a />', { href: '/'+item.foldr_id, 'class': 'foldr item' })
          .text(item.foldr_name)
          .append($('<i class="icon exchange"></i>'))
      );
    });

    // for semantic ui css specificity
    $(".hidden").hide();

    // sidebar expansion buttons
    $("#nav .collapse.button").on("click tap", function(){
      $("#sidebar").css("left","-17rem");
      $("#wrapper").css("padding-left","3rem");
      $(".expanded.mode").hide();
      $(".collapsed.mode").show();
      });
    $("#nav .expand.button").on("click tap", function(){
      $("#sidebar").css("left","0");
      $("#wrapper").css("padding-left","20rem");
      $(".expanded.mode").css("display","");
      $(".collapsed.mode").hide();
      });

    // firefox fix for iframe initial size
    $("#wrapper .frame").addClass("normal size");

    // zoom in buttons
    $(".frame, #iframe").addClass(foldr_scale + " size");

    var set_scale = function(scale){
      $(".frame, #iframe").removeClass("normal large larger").addClass(scale+" size");
      localStorage.setItem("hackfoldr-scale", JSON.stringify(scale));    
    };
    $("#nav .zoom.dropdown .normal").on("click tap", function(){
      set_scale("normal");
    });
    $("#nav .zoom.dropdown .large").on("click tap", function(){
      set_scale("large");
    });
    $("#nav .zoom.dropdown .larger").on("click tap", function(){
      set_scale("larger");
    });

    // refresh table
    // load ethercalc data only instead of loading the whole page
    $("#topbar .refresh.table").on("click tap", function(){
      $("#toc .menu").html("");
      compile_ethercalc();
      });

    // create new hackpad and add to foldr
    $("#topbar .add.to.list").on("click tap", function(){
      $("#topbar .form").slideToggle();
    });

    $("#topbar .form .submit").on("click tap", function(){
      var new_hackpad_title = $("#topbar .form .new.title").val();
      var new_hackpad_id = encodeURIComponent(new_hackpad_title.slice(0,8));
      console.log(new_hackpad_id);
      var new_menu_item = '<a href="https://g0v.hackpad.com/'+new_hackpad_id+'" target="iframe" class="link item">'+new_hackpad_title+'<i class="icon text file outline"></i></a>';
      $('#toc .ui.vertical.menu').prepend(new_menu_item);
      //'https://*.hackpad.com/' + encodeURIComponent(new_hackpad_title)
      });

    //$.ajax({
    //    url: "https://ethercalc.org/_/test-74",
    //    type: 'POST',
    //    contentType: 'text/csv',
    //    processData: false,
    //    data: 'one,two,three'
    //});

    // link item events
    $("#sidebar").on("click tap", "a.link.item", function(event){
      // dynamic url
      var iframe_path = event.target.href;
      if(iframe_path.match(/^https:\/\/.*.hackpad.com\//)){
        iframe_path = iframe_path.split(/\//).pop();
      }
      history.pushState(history_state,'', '/'+ethercalc_name+'/'+encodeURIComponent(encodeURIComponent(iframe_path))) ;

      // when leaving ethercalc, show edit icon again
      if(event.target.target !== "_blank"){
        $("#topbar .edit.table").show();
        $("#topbar .refresh.table").hide();
      }
    });

    // edit table
    $("#topbar .edit.table").attr("href",'https://ethercalc.org/'+ethercalc_name);
    $("#sidebar").on("click tap", "#topbar .edit.table", function(){
      // switch icon
      $("#topbar .edit.table").hide();
      $("#topbar .refresh.table").show();
      // change url
      history.pushState(history_state,'', '/'+ethercalc_name+'/'+"edit") ;
    });

    // add href attr to foldr title
    $("#topbar .foldr.title").attr("href",'/'+ethercalc_name);

    // make current link item active

